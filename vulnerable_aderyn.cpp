#include <iostream>
#include <fstream>
#include <string>
#include <vector>
#include <filesystem>

using namespace std;
namespace fs = std::filesystem;

bool isContractVulnerable(const string& output) {
    bool hasHighIssues = false;
    size_t posHigh = output.find("| High | ");

    if (posHigh != string::npos) {
        // Move to the start of the number after "| High | "
        size_t start = posHigh + 9; // 9 characters to skip "| High | "
        size_t end = output.find(" |", start); // Find the next " |" after the number
        if (end != string::npos) {
            // Convert the substring (which should be the number of high issues) to an integer
            int highIssues = stoi(output.substr(start, end - start));
            if (highIssues > 0) {
                hasHighIssues = true;
            }
        }
    }
    
    return hasHighIssues;
}

int main() {
    string directory = "./output"; // Set the directory path here
    vector<string> contractFiles;

    // Iterate through the directory to find all .sol files
    for (const auto& entry : fs::directory_iterator(directory)) {
        if (entry.path().extension() == ".sol") {
            contractFiles.push_back(entry.path().string());
        }
    }

    int vulnerableCount = 0;
    int analyzedCount = 0;

    for (size_t i = 0; i < contractFiles.size(); ++i) {
        const string& file = contractFiles[i];

        string command = "aderyn -s " + file + " > temp_output2.txt";
        cout<<command<<endl;
        system(command.c_str());
        

        ifstream inputFile("report.md");
        string line, output;
        
        if (inputFile.is_open()) {
            while (getline(inputFile, line)) {
                output += line + "\n";
            }
            inputFile.close();

            if (!isContractVulnerable(output)) {
                // Directory creation and file copy
                string targetDirectory = "non_vulnerable_contracts";
                string targetFile = targetDirectory + "/" + fs::path(file).filename().string();

                if (!fs::exists(targetDirectory)) {
                    fs::create_directory(targetDirectory);
                    cout << "Directory created: " << targetDirectory << endl;
                }

                fs::copy(file, targetFile, fs::copy_options::overwrite_existing);
                cout << "File copied to: " << targetFile << endl;
            } else {
                vulnerableCount++;
            }
        }

        analyzedCount++;
        cout << analyzedCount << "/" << contractFiles.size() << " files analyzed." << endl;
    }

    cout << vulnerableCount << "/" << contractFiles.size() << " are vulnerable." << endl;

    // Clean up
    fs::remove("temp_output.txt");

    return 0;
}
